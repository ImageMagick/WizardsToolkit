/*
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                             %
%                                                                             %
%                                                                             %
%               TTTTT  W   W   OOO   FFFFF  IIIII  SSSSS  H   H               %
%                 T    W   W  O   O  F        I    SS     H   H               %
%                 T    W W W  O   O  FFF      I     SSS   HHHHH               %
%                 T    WW WW  O   O  F        I       SS  H   H               %
%                 T    W   W   OOO   F      IIIII  SSSSS  H   H               %
%                                                                             %
%                                                                             %
%                    Wizard's Toolkit Twofish Cipher Methods                  %
%                                                                             %
%                               Software Design                               %
%                                   Cristy                                    %
%                                 March 2003                                  %
%                                                                             %
%  Copyright 1999-2020 ImageMagick Studio, LLC, Wilmington, DE, U.S.A.  All   %
%  rights reserved.                                                           %
%                                                                             %
%  You may not use this file except in compliance with the License.  You may  %
%  obtain a copy of the License at                                            %
%                                                                             %
%    https://imagemagick.org/script/license.php                               %
%                                                                             %
%  Unless required by applicable law or agreed to in writing, software        %
%  distributed under the License is distributed on an "AS IS" BASIS,          %
%  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.   %
%  See the License for the specific language governing permissions and        %
%  limitations under the License.                                             %
%                                                                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
*/

/*
  Include declarations.
*/
#include "wizard/studio.h"
#include "wizard/exception.h"
#include "wizard/exception-private.h"
#include "wizard/memory_.h"
#include "wizard/twofish.h"

/*
  Typedef declarations.
*/
struct _TwofishInfo
{
  unsigned int
    blocksize,
    k[32],
    sbox[4][256],
    w[8];

  time_t
    timestamp;

  size_t
    signature;
};

/*
  Define declarations.
*/
#define G1(alpha) \
  (twofish_info->sbox[0][(alpha) & 0xFF]) ^ \
  (twofish_info->sbox[1][((alpha) >> 8) & 0xFF]) ^ \
  (twofish_info->sbox[2][((alpha) >> 16) & 0xFF]) ^ \
  (twofish_info->sbox[3][(alpha) >> 24])
#define G2(beta) \
  (twofish_info->sbox[1][(beta) & 0xFF]) ^ \
  (twofish_info->sbox[2][((beta) >> 8) & 0xFF]) ^ \
  (twofish_info->sbox[3][((beta) >> 16) & 0xFF]) ^ \
  (twofish_info->sbox[0][(beta) >> 24])
#define Read32Bits(value,p) \
{ \
  (value)=(*p++); \
  (value)|=(*p++) << 8; \
  (value)|=(*p++) << 16; \
  (value)|=(*p++) << 24; \
}
#define TwofishBlocksize 16
#define Write32Bits(p,value) \
{ \
  *p++=(unsigned char) (value); \
  *p++=(unsigned char) ((value) >> 8); \
  *p++=(unsigned char) ((value) >> 16); \
  *p++=(unsigned char) ((value) >> 24); \
}

/*
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                             %
%                                                                             %
%                                                                             %
%   A c q u i r e T w o f i s h I n f o                                       %
%                                                                             %
%                                                                             %
%                                                                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  AcquireTwofishInfo() allocate the TwofishInfo structure.
%
%  The format of the AcquireTwofishInfo method is:
%
%      TwofishInfo *AcquireTwofishInfo(void)
%
*/
WizardExport TwofishInfo *AcquireTwofishInfo(void)
{
  TwofishInfo
    *twofish_info;

  twofish_info=(TwofishInfo *) AcquireWizardMemory(sizeof(*twofish_info));
  if (twofish_info == (TwofishInfo *) NULL)
    ThrowWizardFatalError(CipherDomain,MemoryError);
  (void) ResetWizardMemory(twofish_info,0,sizeof(*twofish_info));
  twofish_info->blocksize=TwofishBlocksize;
  twofish_info->timestamp=time((time_t *) NULL);
  twofish_info->signature=WizardSignature;
  return(twofish_info);
}

/*
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                             %
%                                                                             %
%                                                                             %
%   D e c i p h e r T w o f i s h B l o c k                                   %
%                                                                             %
%                                                                             %
%                                                                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  DecipherTwofishBlock() deciphers a single block of ciphertext to produce a
%  block of plaintext.
%
%  The format of the DecipherTwofishBlock method is:
%
%     void DecipherTwofishBlock(TwofishInfo *twofish_info,
%       const unsigned char *ciphertext,unsigned char plaintext)
%
%  A description of each parameter follows:
%
%    o twofish_info: The cipher context.
%
%    o ciphertext: The cipher text.
%
%    o plaintext: The plaint text.
%
*/
WizardExport void DecipherTwofishBlock(TwofishInfo *twofish_info,
  const unsigned char *ciphertext,unsigned char *plaintext)
{
#define DecipherRound(alpha,beta,gamma,delta,i) \
{ \
  rho=G1(alpha); sigma=G2(beta); rho+=sigma; sigma+=rho; \
  delta^=sigma+twofish_info->k[2*(i)+1]; delta=(delta >> 1)+(delta << 31); \
  gamma=(gamma << 1)+(gamma >> 31); gamma^=(rho+twofish_info->k[2*(i)]); \
}

  register unsigned char
    *q;

  unsigned int
    alpha,
    beta,
    delta,
    gamma,
    rho,
    sigma;

  /*
    Exercise 16 deciphering rounds.
  */
  gamma=ciphertext[0] ^ (ciphertext[1] << 8) ^ (ciphertext[2] << 16) ^
    (ciphertext[3] << 24) ^ twofish_info->w[4];
  delta=ciphertext[4] ^ (ciphertext[5] << 8) ^ (ciphertext[6] << 16) ^
    (ciphertext[7] << 24) ^ twofish_info->w[5];
  alpha=ciphertext[8] ^ (ciphertext[9] << 8) ^ (ciphertext[10] << 16) ^
    (ciphertext[11] << 24) ^ twofish_info->w[6];
  beta=ciphertext[12] ^ (ciphertext[13] << 8) ^ (ciphertext[14] << 16) ^
    (ciphertext[15] << 24) ^ twofish_info->w[7];
  DecipherRound(gamma,delta,alpha,beta,15);
  DecipherRound(alpha,beta,gamma,delta,14);
  DecipherRound(gamma,delta,alpha,beta,13);
  DecipherRound(alpha,beta,gamma,delta,12);
  DecipherRound(gamma,delta,alpha,beta,11);
  DecipherRound(alpha,beta,gamma,delta,10);
  DecipherRound(gamma,delta,alpha,beta,9);
  DecipherRound(alpha,beta,gamma,delta,8);
  DecipherRound(gamma,delta,alpha,beta,7);
  DecipherRound(alpha,beta,gamma,delta,6);
  DecipherRound(gamma,delta,alpha,beta,5);
  DecipherRound(alpha,beta,gamma,delta,4);
  DecipherRound(gamma,delta,alpha,beta,3);
  DecipherRound(alpha,beta,gamma,delta,2);
  DecipherRound(gamma,delta,alpha,beta,1);
  DecipherRound(alpha,beta,gamma,delta,0);
  q=(unsigned char *) plaintext;
  alpha^=twofish_info->w[0];
  Write32Bits(q,alpha);
  beta^=twofish_info->w[1];
  Write32Bits(q,beta);
  gamma^=twofish_info->w[2];
  Write32Bits(q,gamma);
  delta^=twofish_info->w[3];
  Write32Bits(q,delta);
  /*
    Reset registers.
  */
  alpha=0;
  beta=0;
  gamma=0;
  delta=0;
  rho=0;
  sigma=0;
}

/*
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                             %
%                                                                             %
%                                                                             %
%   D e s t r o y T w o f i s h I n f o                                       %
%                                                                             %
%                                                                             %
%                                                                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  DestroyTwofishInfo() zeros memory associated with the TwofishInfo structure.
%
%  The format of the DestroyTwofishInfo method is:
%
%      TwofishInfo *DestroyTwofishInfo(TwofishInfo *twofish_info)
%
%  A description of each parameter follows:
%
%    o twofish_info: The cipher context.
%
*/
WizardExport TwofishInfo *DestroyTwofishInfo(TwofishInfo *twofish_info)
{
  (void) LogWizardEvent(TraceEvent,GetWizardModule(),"...");
  WizardAssert(CipherDomain,twofish_info != (TwofishInfo *) NULL);
  WizardAssert(CipherDomain,twofish_info->signature == WizardSignature);
  twofish_info->signature=(~WizardSignature);
  twofish_info=(TwofishInfo *) RelinquishWizardMemory(twofish_info);
  return(twofish_info);
}

/*
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                             %
%                                                                             %
%                                                                             %
%   E n c i p h e r T w o f i s h B l o c k                                   %
%                                                                             %
%                                                                             %
%                                                                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  EncipherTwofishBlock() encipher a single block of plaintext to produce a
%  block of ciphertext.
%
%  The format of the EncipherTwofishBlock method is:
%
%      void EncipherTwofishBlock(TwofishInfo *twofish_info,
%        const unsigned char *plaintext,unsigned char *ciphertext)
%
%  A description of each parameter follows:
%
%    o twofish_info: The cipher context.
%
%    o plaintext: The plain text.
%
%    o ciphertext: The cipher text.
%
*/
WizardExport void EncipherTwofishBlock(TwofishInfo *twofish_info,
  const unsigned char *plaintext,unsigned char *ciphertext)
{
#define EncipherRound(alpha,beta,gamma,delta,i) \
{ \
  rho=G1(alpha); sigma=G2(beta); \
  rho+=sigma; sigma+=rho+twofish_info->k[2*(i)+1]; \
  gamma^=rho+twofish_info->k[2*(i)]; gamma=(gamma >> 1)+(gamma << 31); \
  delta=((delta << 1)+(delta >> 31)) ^ sigma; \
}

  register unsigned char
    *q;

  unsigned int
    alpha,
    beta,
    gamma,
    delta,
    rho,
    sigma;

  /*
    Exercise 16 enciphering rounds.
  */
  alpha=plaintext[0] ^ (plaintext[1] << 8) ^ (plaintext[2] << 16) ^
    (plaintext[3] << 24) ^ twofish_info->w[0];
  beta=plaintext[4] ^ (plaintext[5] << 8) ^ (plaintext[6] << 16) ^
    (plaintext[7] << 24) ^ twofish_info->w[1];
  gamma=plaintext[8] ^ (plaintext[9] << 8) ^ (plaintext[10] << 16) ^
    (plaintext[11] << 24) ^ twofish_info->w[2];
  delta=plaintext[12] ^ (plaintext[13] << 8) ^ (plaintext[14] << 16) ^
    (plaintext[15] << 24) ^ twofish_info->w[3];
  EncipherRound(alpha,beta,gamma,delta,0);
  EncipherRound(gamma,delta,alpha,beta,1)
  EncipherRound(alpha,beta,gamma,delta,2);
  EncipherRound(gamma,delta,alpha,beta,3)
  EncipherRound(alpha,beta,gamma,delta,4);
  EncipherRound(gamma,delta,alpha,beta,5)
  EncipherRound(alpha,beta,gamma,delta,6);
  EncipherRound(gamma,delta,alpha,beta,7)
  EncipherRound(alpha,beta,gamma,delta,8);
  EncipherRound(gamma,delta,alpha,beta,9)
  EncipherRound(alpha,beta,gamma,delta,10);
  EncipherRound(gamma,delta,alpha,beta,11)
  EncipherRound(alpha,beta,gamma,delta,12);
  EncipherRound(gamma,delta,alpha,beta,13)
  EncipherRound(alpha,beta,gamma,delta,14);
  EncipherRound(gamma,delta,alpha,beta,15)
  q=(unsigned char *) ciphertext;
  gamma^=twofish_info->w[4];
  Write32Bits(q,gamma);
  delta^=twofish_info->w[5];
  Write32Bits(q,delta);
  alpha^=twofish_info->w[6];
  Write32Bits(q,alpha);
  beta^=twofish_info->w[7];
  Write32Bits(q,beta);
  /*
    Reset registers.
  */
  alpha=0;
  beta=0;
  gamma=0;
  delta=0;
  rho=0;
  sigma=0;
}

/*
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                             %
%                                                                             %
%                                                                             %
%   G e t T w o s i z e B l o c k s i z e                                     %
%                                                                             %
%                                                                             %
%                                                                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  GetTwofishBlocksize() returns the Twofish blocksize.
%
%  The format of the GetTwofishBlocksize method is:
%
%      unsigned int *GetTwofishBlocksize(const TwofishInfo *twofish_info)
%
%  A description of each parameter follows:
%
%    o twofish_info: The twofish info.
%
*/
WizardExport unsigned int GetTwofishBlocksize(const TwofishInfo *twofish_info)
{
  (void) LogWizardEvent(TraceEvent,GetWizardModule(),"...");
  WizardAssert(CipherDomain,twofish_info != (TwofishInfo *) NULL);
  WizardAssert(CipherDomain,twofish_info->signature == WizardSignature);
  return(twofish_info->blocksize);
}

/*
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                             %
%                                                                             %
%                                                                             %
%   S e t T w o f i s h K e y                                                 %
%                                                                             %
%                                                                             %
%                                                                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  SetTwofishKey() sets the key for the Twofish cipher.  The key length is
%  specified in bits.  Valid values are 128, 192, or 256 requiring a key
%  buffer length in bytes of 16, 24, and 32 respectively.
%
%  The format of the SetTwofishKey method is:
%
%      SetTwofishKey(TwofishInfo *twofish_info,const StringInfo *key)
%
%  A description of each parameter follows:
%
%    o twofish_info: The cipher context.
%
%    o key: The key.
%
*/
WizardExport void SetTwofishKey(TwofishInfo *twofish_info,const StringInfo *key)
{
#define K128(x,j,k,l,m,n) \
{ \
  rho=Q128(k,l,k,l,0); sigma=Q128(m,n,m,n,4); \
  sigma=(sigma << 8)+(sigma >> 24); rho+=sigma; sigma+=rho; \
  twofish_info->x[j]=rho; twofish_info->x[(j)+1]=(sigma << 9)+(sigma >> 23); \
}
#define K192(x,j,k,l,m,n) \
{ \
  rho=Q192(l,l,k,k,0); sigma=Q192(n,n,m,m,4); \
  sigma=(sigma << 8)+(sigma >> 24); rho+=sigma; sigma+=rho; \
  twofish_info->x[j]=rho; twofish_info->x[(j)+1]=(sigma << 9)+(sigma >> 23); \
}
#define K256(x,j,k,l,m,n) \
{ \
  rho=Q256(k,l,0); sigma=Q256(m,n,4); \
  sigma=(sigma << 8)+(sigma >> 24); rho+=sigma; sigma+=rho; \
  twofish_info->x[j]=rho; twofish_info->x[(j)+1]=(sigma << 9)+(sigma >> 23); \
}
#define MaximumTwofishKeyLength  32
#define Q128(alpha,beta,gamma,delta,i) \
  mds[0][q0[alpha ^ crypt_key[(i)+8]] ^ crypt_key[i]] ^ \
  mds[1][q0[beta ^ crypt_key[(i)+9]] ^ crypt_key[(i)+1]] ^ \
  mds[2][q1[gamma ^ crypt_key[(i)+10]] ^ crypt_key[(i)+2]] ^ \
  mds[3][q1[delta ^ crypt_key[(i)+11]] ^ crypt_key[(i)+3]]
#define Q192(alpha,beta,gamma,delta,i) \
  Q128(q0[alpha ^ crypt_key[(i)+16]],q1[beta ^ crypt_key[(i)+17]], \
    q0[gamma ^ crypt_key[(i)+18]],q1[delta ^ crypt_key[(i)+19]],i)
#define Q256(alpha,beta,i) \
  Q192(q1[beta ^ crypt_key[(i)+24]],q1[alpha ^ crypt_key[(i)+25]], \
    q0[alpha ^ crypt_key[(i)+26]],q0[beta ^ crypt_key[(i)+27]],i)
#define Sbox(alpha,beta,gamma,delta,i,w,x,y,z) \
{ \
  if (crypt_key[i] != 0) \
    { \
      xi=polynomial_to_exponent[crypt_key[i]-1]; \
      (alpha)^=exponent_to_polynomial[xi+(w)]; \
      (beta)^=exponent_to_polynomial[xi+(x)]; \
      (gamma)^=exponent_to_polynomial[xi+(y)]; \
      (delta)^=exponent_to_polynomial[xi+(z)]; \
   } \
}

  static const unsigned char
    exponent_to_polynomial[492] =
    {
      0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x4D, 0x9A, 0x79,
      0xF2, 0xA9, 0x1F, 0x3E, 0x7C, 0xF8, 0xBD, 0x37, 0x6E, 0xDC, 0xF5,
      0xA7, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0xCD, 0xD7, 0xE3,
      0x8B, 0x5B, 0xB6, 0x21, 0x42, 0x84, 0x45, 0x8A, 0x59, 0xB2, 0x29,
      0x52, 0xA4, 0x05, 0x0A, 0x14, 0x28, 0x50, 0xA0, 0x0D, 0x1A, 0x34,
      0x68, 0xD0, 0xED, 0x97, 0x63, 0xC6, 0xC1, 0xCF, 0xD3, 0xEB, 0x9B,
      0x7B, 0xF6, 0xA1, 0x0F, 0x1E, 0x3C, 0x78, 0xF0, 0xAD, 0x17, 0x2E,
      0x5C, 0xB8, 0x3D, 0x7A, 0xF4, 0xA5, 0x07, 0x0E, 0x1C, 0x38, 0x70,
      0xE0, 0x8D, 0x57, 0xAE, 0x11, 0x22, 0x44, 0x88, 0x5D, 0xBA, 0x39,
      0x72, 0xE4, 0x85, 0x47, 0x8E, 0x51, 0xA2, 0x09, 0x12, 0x24, 0x48,
      0x90, 0x6D, 0xDA, 0xF9, 0xBF, 0x33, 0x66, 0xCC, 0xD5, 0xE7, 0x83,
      0x4B, 0x96, 0x61, 0xC2, 0xC9, 0xDF, 0xF3, 0xAB, 0x1B, 0x36, 0x6C,
      0xD8, 0xFD, 0xB7, 0x23, 0x46, 0x8C, 0x55, 0xAA, 0x19, 0x32, 0x64,
      0xC8, 0xDD, 0xF7, 0xA3, 0x0B, 0x16, 0x2C, 0x58, 0xB0, 0x2D, 0x5A,
      0xB4, 0x25, 0x4A, 0x94, 0x65, 0xCA, 0xD9, 0xFF, 0xB3, 0x2B, 0x56,
      0xAC, 0x15, 0x2A, 0x54, 0xA8, 0x1D, 0x3A, 0x74, 0xE8, 0x9D, 0x77,
      0xEE, 0x91, 0x6F, 0xDE, 0xF1, 0xAF, 0x13, 0x26, 0x4C, 0x98, 0x7D,
      0xFA, 0xB9, 0x3F, 0x7E, 0xFC, 0xB5, 0x27, 0x4E, 0x9C, 0x75, 0xEA,
      0x99, 0x7F, 0xFE, 0xB1, 0x2F, 0x5E, 0xBC, 0x35, 0x6A, 0xD4, 0xE5,
      0x87, 0x43, 0x86, 0x41, 0x82, 0x49, 0x92, 0x69, 0xD2, 0xE9, 0x9F,
      0x73, 0xE6, 0x81, 0x4F, 0x9E, 0x71, 0xE2, 0x89, 0x5F, 0xBE, 0x31,
      0x62, 0xC4, 0xC5, 0xC7, 0xC3, 0xCB, 0xDB, 0xFB, 0xBB, 0x3B, 0x76,
      0xEC, 0x95, 0x67, 0xCE, 0xD1, 0xEF, 0x93, 0x6B, 0xD6, 0xE1, 0x8F,
      0x53, 0xA6, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x4D,
      0x9A, 0x79, 0xF2, 0xA9, 0x1F, 0x3E, 0x7C, 0xF8, 0xBD, 0x37, 0x6E,
      0xDC, 0xF5, 0xA7, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0xCD,
      0xD7, 0xE3, 0x8B, 0x5B, 0xB6, 0x21, 0x42, 0x84, 0x45, 0x8A, 0x59,
      0xB2, 0x29, 0x52, 0xA4, 0x05, 0x0A, 0x14, 0x28, 0x50, 0xA0, 0x0D,
      0x1A, 0x34, 0x68, 0xD0, 0xED, 0x97, 0x63, 0xC6, 0xC1, 0xCF, 0xD3,
      0xEB, 0x9B, 0x7B, 0xF6, 0xA1, 0x0F, 0x1E, 0x3C, 0x78, 0xF0, 0xAD,
      0x17, 0x2E, 0x5C, 0xB8, 0x3D, 0x7A, 0xF4, 0xA5, 0x07, 0x0E, 0x1C,
      0x38, 0x70, 0xE0, 0x8D, 0x57, 0xAE, 0x11, 0x22, 0x44, 0x88, 0x5D,
      0xBA, 0x39, 0x72, 0xE4, 0x85, 0x47, 0x8E, 0x51, 0xA2, 0x09, 0x12,
      0x24, 0x48, 0x90, 0x6D, 0xDA, 0xF9, 0xBF, 0x33, 0x66, 0xCC, 0xD5,
      0xE7, 0x83, 0x4B, 0x96, 0x61, 0xC2, 0xC9, 0xDF, 0xF3, 0xAB, 0x1B,
      0x36, 0x6C, 0xD8, 0xFD, 0xB7, 0x23, 0x46, 0x8C, 0x55, 0xAA, 0x19,
      0x32, 0x64, 0xC8, 0xDD, 0xF7, 0xA3, 0x0B, 0x16, 0x2C, 0x58, 0xB0,
      0x2D, 0x5A, 0xB4, 0x25, 0x4A, 0x94, 0x65, 0xCA, 0xD9, 0xFF, 0xB3,
      0x2B, 0x56, 0xAC, 0x15, 0x2A, 0x54, 0xA8, 0x1D, 0x3A, 0x74, 0xE8,
      0x9D, 0x77, 0xEE, 0x91, 0x6F, 0xDE, 0xF1, 0xAF, 0x13, 0x26, 0x4C,
      0x98, 0x7D, 0xFA, 0xB9, 0x3F, 0x7E, 0xFC, 0xB5, 0x27, 0x4E, 0x9C,
      0x75, 0xEA, 0x99, 0x7F, 0xFE, 0xB1, 0x2F, 0x5E, 0xBC, 0x35, 0x6A,
      0xD4, 0xE5, 0x87, 0x43, 0x86, 0x41, 0x82, 0x49, 0x92, 0x69, 0xD2,
      0xE9, 0x9F, 0x73, 0xE6, 0x81, 0x4F, 0x9E, 0x71, 0xE2, 0x89, 0x5F,
      0xBE, 0x31, 0x62, 0xC4, 0xC5, 0xC7, 0xC3, 0xCB
    },
    polynomial_to_exponent[255] =
    {
      0x00, 0x01, 0x17, 0x02, 0x2E, 0x18, 0x53, 0x03, 0x6A, 0x2F, 0x93,
      0x19, 0x34, 0x54, 0x45, 0x04, 0x5C, 0x6B, 0xB6, 0x30, 0xA6, 0x94,
      0x4B, 0x1A, 0x8C, 0x35, 0x81, 0x55, 0xAA, 0x46, 0x0D, 0x05, 0x24,
      0x5D, 0x87, 0x6C, 0x9B, 0xB7, 0xC1, 0x31, 0x2B, 0xA7, 0xA3, 0x95,
      0x98, 0x4C, 0xCA, 0x1B, 0xE6, 0x8D, 0x73, 0x36, 0xCD, 0x82, 0x12,
      0x56, 0x62, 0xAB, 0xF0, 0x47, 0x4F, 0x0E, 0xBD, 0x06, 0xD4, 0x25,
      0xD2, 0x5E, 0x27, 0x88, 0x66, 0x6D, 0xD6, 0x9C, 0x79, 0xB8, 0x08,
      0xC2, 0xDF, 0x32, 0x68, 0x2C, 0xFD, 0xA8, 0x8A, 0xA4, 0x5A, 0x96,
      0x29, 0x99, 0x22, 0x4D, 0x60, 0xCB, 0xE4, 0x1C, 0x7B, 0xE7, 0x3B,
      0x8E, 0x9E, 0x74, 0xF4, 0x37, 0xD8, 0xCE, 0xF9, 0x83, 0x6F, 0x13,
      0xB2, 0x57, 0xE1, 0x63, 0xDC, 0xAC, 0xC4, 0xF1, 0xAF, 0x48, 0x0A,
      0x50, 0x42, 0x0F, 0xBA, 0xBE, 0xC7, 0x07, 0xDE, 0xD5, 0x78, 0x26,
      0x65, 0xD3, 0xD1, 0x5F, 0xE3, 0x28, 0x21, 0x89, 0x59, 0x67, 0xFC,
      0x6E, 0xB1, 0xD7, 0xF8, 0x9D, 0xF3, 0x7A, 0x3A, 0xB9, 0xC6, 0x09,
      0x41, 0xC3, 0xAE, 0xE0, 0xDB, 0x33, 0x44, 0x69, 0x92, 0x2D, 0x52,
      0xFE, 0x16, 0xA9, 0x0C, 0x8B, 0x80, 0xA5, 0x4A, 0x5B, 0xB5, 0x97,
      0xC9, 0x2A, 0xA2, 0x9A, 0xC0, 0x23, 0x86, 0x4E, 0xBC, 0x61, 0xEF,
      0xCC, 0x11, 0xE5, 0x72, 0x1D, 0x3D, 0x7C, 0xEB, 0xE8, 0xE9, 0x3C,
      0xEA, 0x8F, 0x7D, 0x9F, 0xEC, 0x75, 0x1E, 0xF5, 0x3E, 0x38, 0xF6,
      0xD9, 0x3F, 0xCF, 0x76, 0xFA, 0x1F, 0x84, 0xA0, 0x70, 0xED, 0x14,
      0x90, 0xB3, 0x7E, 0x58, 0xFB, 0xE2, 0x20, 0x64, 0xD0, 0xDD, 0x77,
      0xAD, 0xDA, 0xC5, 0x40, 0xF2, 0x39, 0xB0, 0xF7, 0x49, 0xB4, 0x0B,
      0x7F, 0x51, 0x15, 0x43, 0x91, 0x10, 0x71, 0xBB, 0xEE, 0xBF, 0x85,
      0xC8, 0xA1
    },
    q0[256] =
    {
       0xA9, 0x67, 0xB3, 0xE8, 0x04, 0xFD, 0xA3, 0x76, 0x9A, 0x92, 0x80,
       0x78, 0xE4, 0xDD, 0xD1, 0x38, 0x0D, 0xC6, 0x35, 0x98, 0x18, 0xF7,
       0xEC, 0x6C, 0x43, 0x75, 0x37, 0x26, 0xFA, 0x13, 0x94, 0x48, 0xF2,
       0xD0, 0x8B, 0x30, 0x84, 0x54, 0xDF, 0x23, 0x19, 0x5B, 0x3D, 0x59,
       0xF3, 0xAE, 0xA2, 0x82, 0x63, 0x01, 0x83, 0x2E, 0xD9, 0x51, 0x9B,
       0x7C, 0xA6, 0xEB, 0xA5, 0xBE, 0x16, 0x0C, 0xE3, 0x61, 0xC0, 0x8C,
       0x3A, 0xF5, 0x73, 0x2C, 0x25, 0x0B, 0xBB, 0x4E, 0x89, 0x6B, 0x53,
       0x6A, 0xB4, 0xF1, 0xE1, 0xE6, 0xBD, 0x45, 0xE2, 0xF4, 0xB6, 0x66,
       0xCC, 0x95, 0x03, 0x56, 0xD4, 0x1C, 0x1E, 0xD7, 0xFB, 0xC3, 0x8E,
       0xB5, 0xE9, 0xCF, 0xBF, 0xBA, 0xEA, 0x77, 0x39, 0xAF, 0x33, 0xC9,
       0x62, 0x71, 0x81, 0x79, 0x09, 0xAD, 0x24, 0xCD, 0xF9, 0xD8, 0xE5,
       0xC5, 0xB9, 0x4D, 0x44, 0x08, 0x86, 0xE7, 0xA1, 0x1D, 0xAA, 0xED,
       0x06, 0x70, 0xB2, 0xD2, 0x41, 0x7B, 0xA0, 0x11, 0x31, 0xC2, 0x27,
       0x90, 0x20, 0xF6, 0x60, 0xFF, 0x96, 0x5C, 0xB1, 0xAB, 0x9E, 0x9C,
       0x52, 0x1B, 0x5F, 0x93, 0x0A, 0xEF, 0x91, 0x85, 0x49, 0xEE, 0x2D,
       0x4F, 0x8F, 0x3B, 0x47, 0x87, 0x6D, 0x46, 0xD6, 0x3E, 0x69, 0x64,
       0x2A, 0xCE, 0xCB, 0x2F, 0xFC, 0x97, 0x05, 0x7A, 0xAC, 0x7F, 0xD5,
       0x1A, 0x4B, 0x0E, 0xA7, 0x5A, 0x28, 0x14, 0x3F, 0x29, 0x88, 0x3C,
       0x4C, 0x02, 0xB8, 0xDA, 0xB0, 0x17, 0x55, 0x1F, 0x8A, 0x7D, 0x57,
       0xC7, 0x8D, 0x74, 0xB7, 0xC4, 0x9F, 0x72, 0x7E, 0x15, 0x22, 0x12,
       0x58, 0x07, 0x99, 0x34, 0x6E, 0x50, 0xDE, 0x68, 0x65, 0xBC, 0xDB,
       0xF8, 0xC8, 0xA8, 0x2B, 0x40, 0xDC, 0xFE, 0x32, 0xA4, 0xCA, 0x10,
       0x21, 0xF0, 0xD3, 0x5D, 0x0F, 0x00, 0x6F, 0x9D, 0x36, 0x42, 0x4A,
       0x5E, 0xC1, 0xE0
    },
    q1[256] =
    {
       0x75, 0xF3, 0xC6, 0xF4, 0xDB, 0x7B, 0xFB, 0xC8, 0x4A, 0xD3, 0xE6,
       0x6B, 0x45, 0x7D, 0xE8, 0x4B, 0xD6, 0x32, 0xD8, 0xFD, 0x37, 0x71,
       0xF1, 0xE1, 0x30, 0x0F, 0xF8, 0x1B, 0x87, 0xFA, 0x06, 0x3F, 0x5E,
       0xBA, 0xAE, 0x5B, 0x8A, 0x00, 0xBC, 0x9D, 0x6D, 0xC1, 0xB1, 0x0E,
       0x80, 0x5D, 0xD2, 0xD5, 0xA0, 0x84, 0x07, 0x14, 0xB5, 0x90, 0x2C,
       0xA3, 0xB2, 0x73, 0x4C, 0x54, 0x92, 0x74, 0x36, 0x51, 0x38, 0xB0,
       0xBD, 0x5A, 0xFC, 0x60, 0x62, 0x96, 0x6C, 0x42, 0xF7, 0x10, 0x7C,
       0x28, 0x27, 0x8C, 0x13, 0x95, 0x9C, 0xC7, 0x24, 0x46, 0x3B, 0x70,
       0xCA, 0xE3, 0x85, 0xCB, 0x11, 0xD0, 0x93, 0xB8, 0xA6, 0x83, 0x20,
       0xFF, 0x9F, 0x77, 0xC3, 0xCC, 0x03, 0x6F, 0x08, 0xBF, 0x40, 0xE7,
       0x2B, 0xE2, 0x79, 0x0C, 0xAA, 0x82, 0x41, 0x3A, 0xEA, 0xB9, 0xE4,
       0x9A, 0xA4, 0x97, 0x7E, 0xDA, 0x7A, 0x17, 0x66, 0x94, 0xA1, 0x1D,
       0x3D, 0xF0, 0xDE, 0xB3, 0x0B, 0x72, 0xA7, 0x1C, 0xEF, 0xD1, 0x53,
       0x3E, 0x8F, 0x33, 0x26, 0x5F, 0xEC, 0x76, 0x2A, 0x49, 0x81, 0x88,
       0xEE, 0x21, 0xC4, 0x1A, 0xEB, 0xD9, 0xC5, 0x39, 0x99, 0xCD, 0xAD,
       0x31, 0x8B, 0x01, 0x18, 0x23, 0xDD, 0x1F, 0x4E, 0x2D, 0xF9, 0x48,
       0x4F, 0xF2, 0x65, 0x8E, 0x78, 0x5C, 0x58, 0x19, 0x8D, 0xE5, 0x98,
       0x57, 0x67, 0x7F, 0x05, 0x64, 0xAF, 0x63, 0xB6, 0xFE, 0xF5, 0xB7,
       0x3C, 0xA5, 0xCE, 0xE9, 0x68, 0x44, 0xE0, 0x4D, 0x43, 0x69, 0x29,
       0x2E, 0xAC, 0x15, 0x59, 0xA8, 0x0A, 0x9E, 0x6E, 0x47, 0xDF, 0x34,
       0x35, 0x6A, 0xCF, 0xDC, 0x22, 0xC9, 0xC0, 0x9B, 0x89, 0xD4, 0xED,
       0xAB, 0x12, 0xA2, 0x0D, 0x52, 0xBB, 0x02, 0x2F, 0xA9, 0xD7, 0x61,
       0x1E, 0xB4, 0x50, 0x04, 0xF6, 0xC2, 0x16, 0x25, 0x86, 0x56, 0x55,
       0x09, 0xBE, 0x91
    },
    sbox[512] =
    {
      0xA9, 0x75, 0x67, 0xF3, 0xB3, 0xC6, 0xE8, 0xF4, 0x04, 0xDB, 0xFD,
      0x7B, 0xA3, 0xFB, 0x76, 0xC8, 0x9A, 0x4A, 0x92, 0xD3, 0x80, 0xE6,
      0x78, 0x6B, 0xE4, 0x45, 0xDD, 0x7D, 0xD1, 0xE8, 0x38, 0x4B, 0x0D,
      0xD6, 0xC6, 0x32, 0x35, 0xD8, 0x98, 0xFD, 0x18, 0x37, 0xF7, 0x71,
      0xEC, 0xF1, 0x6C, 0xE1, 0x43, 0x30, 0x75, 0x0F, 0x37, 0xF8, 0x26,
      0x1B, 0xFA, 0x87, 0x13, 0xFA, 0x94, 0x06, 0x48, 0x3F, 0xF2, 0x5E,
      0xD0, 0xBA, 0x8B, 0xAE, 0x30, 0x5B, 0x84, 0x8A, 0x54, 0x00, 0xDF,
      0xBC, 0x23, 0x9D, 0x19, 0x6D, 0x5B, 0xC1, 0x3D, 0xB1, 0x59, 0x0E,
      0xF3, 0x80, 0xAE, 0x5D, 0xA2, 0xD2, 0x82, 0xD5, 0x63, 0xA0, 0x01,
      0x84, 0x83, 0x07, 0x2E, 0x14, 0xD9, 0xB5, 0x51, 0x90, 0x9B, 0x2C,
      0x7C, 0xA3, 0xA6, 0xB2, 0xEB, 0x73, 0xA5, 0x4C, 0xBE, 0x54, 0x16,
      0x92, 0x0C, 0x74, 0xE3, 0x36, 0x61, 0x51, 0xC0, 0x38, 0x8C, 0xB0,
      0x3A, 0xBD, 0xF5, 0x5A, 0x73, 0xFC, 0x2C, 0x60, 0x25, 0x62, 0x0B,
      0x96, 0xBB, 0x6C, 0x4E, 0x42, 0x89, 0xF7, 0x6B, 0x10, 0x53, 0x7C,
      0x6A, 0x28, 0xB4, 0x27, 0xF1, 0x8C, 0xE1, 0x13, 0xE6, 0x95, 0xBD,
      0x9C, 0x45, 0xC7, 0xE2, 0x24, 0xF4, 0x46, 0xB6, 0x3B, 0x66, 0x70,
      0xCC, 0xCA, 0x95, 0xE3, 0x03, 0x85, 0x56, 0xCB, 0xD4, 0x11, 0x1C,
      0xD0, 0x1E, 0x93, 0xD7, 0xB8, 0xFB, 0xA6, 0xC3, 0x83, 0x8E, 0x20,
      0xB5, 0xFF, 0xE9, 0x9F, 0xCF, 0x77, 0xBF, 0xC3, 0xBA, 0xCC, 0xEA,
      0x03, 0x77, 0x6F, 0x39, 0x08, 0xAF, 0xBF, 0x33, 0x40, 0xC9, 0xE7,
      0x62, 0x2B, 0x71, 0xE2, 0x81, 0x79, 0x79, 0x0C, 0x09, 0xAA, 0xAD,
      0x82, 0x24, 0x41, 0xCD, 0x3A, 0xF9, 0xEA, 0xD8, 0xB9, 0xE5, 0xE4,
      0xC5, 0x9A, 0xB9, 0xA4, 0x4D, 0x97, 0x44, 0x7E, 0x08, 0xDA, 0x86,
      0x7A, 0xE7, 0x17, 0xA1, 0x66, 0x1D, 0x94, 0xAA, 0xA1, 0xED, 0x1D,
      0x06, 0x3D, 0x70, 0xF0, 0xB2, 0xDE, 0xD2, 0xB3, 0x41, 0x0B, 0x7B,
      0x72, 0xA0, 0xA7, 0x11, 0x1C, 0x31, 0xEF, 0xC2, 0xD1, 0x27, 0x53,
      0x90, 0x3E, 0x20, 0x8F, 0xF6, 0x33, 0x60, 0x26, 0xFF, 0x5F, 0x96,
      0xEC, 0x5C, 0x76, 0xB1, 0x2A, 0xAB, 0x49, 0x9E, 0x81, 0x9C, 0x88,
      0x52, 0xEE, 0x1B, 0x21, 0x5F, 0xC4, 0x93, 0x1A, 0x0A, 0xEB, 0xEF,
      0xD9, 0x91, 0xC5, 0x85, 0x39, 0x49, 0x99, 0xEE, 0xCD, 0x2D, 0xAD,
      0x4F, 0x31, 0x8F, 0x8B, 0x3B, 0x01, 0x47, 0x18, 0x87, 0x23, 0x6D,
      0xDD, 0x46, 0x1F, 0xD6, 0x4E, 0x3E, 0x2D, 0x69, 0xF9, 0x64, 0x48,
      0x2A, 0x4F, 0xCE, 0xF2, 0xCB, 0x65, 0x2F, 0x8E, 0xFC, 0x78, 0x97,
      0x5C, 0x05, 0x58, 0x7A, 0x19, 0xAC, 0x8D, 0x7F, 0xE5, 0xD5, 0x98,
      0x1A, 0x57, 0x4B, 0x67, 0x0E, 0x7F, 0xA7, 0x05, 0x5A, 0x64, 0x28,
      0xAF, 0x14, 0x63, 0x3F, 0xB6, 0x29, 0xFE, 0x88, 0xF5, 0x3C, 0xB7,
      0x4C, 0x3C, 0x02, 0xA5, 0xB8, 0xCE, 0xDA, 0xE9, 0xB0, 0x68, 0x17,
      0x44, 0x55, 0xE0, 0x1F, 0x4D, 0x8A, 0x43, 0x7D, 0x69, 0x57, 0x29,
      0xC7, 0x2E, 0x8D, 0xAC, 0x74, 0x15, 0xB7, 0x59, 0xC4, 0xA8, 0x9F,
      0x0A, 0x72, 0x9E, 0x7E, 0x6E, 0x15, 0x47, 0x22, 0xDF, 0x12, 0x34,
      0x58, 0x35, 0x07, 0x6A, 0x99, 0xCF, 0x34, 0xDC, 0x6E, 0x22, 0x50,
      0xC9, 0xDE, 0xC0, 0x68, 0x9B, 0x65, 0x89, 0xBC, 0xD4, 0xDB, 0xED,
      0xF8, 0xAB, 0xC8, 0x12, 0xA8, 0xA2, 0x2B, 0x0D, 0x40, 0x52, 0xDC,
      0xBB, 0xFE, 0x02, 0x32, 0x2F, 0xA4, 0xA9, 0xCA, 0xD7, 0x10, 0x61,
      0x21, 0x1E, 0xF0, 0xB4, 0xD3, 0x50, 0x5D, 0x04, 0x0F, 0xF6, 0x00,
      0xC2, 0x6F, 0x16, 0x9D, 0x25, 0x36, 0x86, 0x42, 0x56, 0x4A, 0x55,
      0x5E, 0x09, 0xC1, 0xBE, 0xE0, 0x91
    };

  static const unsigned int
    mds[4][256] =
    {
      { 0xBCBC3275U, 0xECEC21F3U, 0x202043C6U, 0xB3B3C9F4U, 0xDADA03DBU,
        0x02028B7BU, 0xE2E22BFBU, 0x9E9EFAC8U, 0xC9C9EC4AU, 0xD4D409D3U,
        0x18186BE6U, 0x1E1E9F6BU, 0x98980E45U, 0xB2B2387DU, 0xA6A6D2E8U,
        0x2626B74BU, 0x3C3C57D6U, 0x93938A32U, 0x8282EED8U, 0x525298FDU,
        0x7B7BD437U, 0xBBBB3771U, 0x5B5B97F1U, 0x474783E1U, 0x24243C30U,
        0x5151E20FU, 0xBABAC6F8U, 0x4A4AF31BU, 0xBFBF4887U, 0x0D0D70FAU,
        0xB0B0B306U, 0x7575DE3FU, 0xD2D2FD5EU, 0x7D7D20BAU, 0x666631AEU,
        0x3A3AA35BU, 0x59591C8AU, 0x00000000U, 0xCDCD93BCU, 0x1A1AE09DU,
        0xAEAE2C6DU, 0x7F7FABC1U, 0x2B2BC7B1U, 0xBEBEB90EU, 0xE0E0A080U,
        0x8A8A105DU, 0x3B3B52D2U, 0x6464BAD5U, 0xD8D888A0U, 0xE7E7A584U,
        0x5F5FE807U, 0x1B1B1114U, 0x2C2CC2B5U, 0xFCFCB490U, 0x3131272CU,
        0x808065A3U, 0x73732AB2U, 0x0C0C8173U, 0x79795F4CU, 0x6B6B4154U,
        0x4B4B0292U, 0x53536974U, 0x94948F36U, 0x83831F51U, 0x2A2A3638U,
        0xC4C49CB0U, 0x2222C8BDU, 0xD5D5F85AU, 0xBDBDC3FCU, 0x48487860U,
        0xFFFFCE62U, 0x4C4C0796U, 0x4141776CU, 0xC7C7E642U, 0xEBEB24F7U,
        0x1C1C1410U, 0x5D5D637CU, 0x36362228U, 0x6767C027U, 0xE9E9AF8CU,
        0x4444F913U, 0x1414EA95U, 0xF5F5BB9CU, 0xCFCF18C7U, 0x3F3F2D24U,
        0xC0C0E346U, 0x7272DB3BU, 0x54546C70U, 0x29294CCAU, 0xF0F035E3U,
        0x0808FE85U, 0xC6C617CBU, 0xF3F34F11U, 0x8C8CE4D0U, 0xA4A45993U,
        0xCACA96B8U, 0x68683BA6U, 0xB8B84D83U, 0x38382820U, 0xE5E52EFFU,
        0xADAD569FU, 0x0B0B8477U, 0xC8C81DC3U, 0x9999FFCCU, 0x5858ED03U,
        0x19199A6FU, 0x0E0E0A08U, 0x95957EBFU, 0x70705040U, 0xF7F730E7U,
        0x6E6ECF2BU, 0x1F1F6EE2U, 0xB5B53D79U, 0x09090F0CU, 0x616134AAU,
        0x57571682U, 0x9F9F0B41U, 0x9D9D803AU, 0x111164EAU, 0x2525CDB9U,
        0xAFAFDDE4U, 0x4545089AU, 0xDFDF8DA4U, 0xA3A35C97U, 0xEAEAD57EU,
        0x353558DAU, 0xEDEDD07AU, 0x4343FC17U, 0xF8F8CB66U, 0xFBFBB194U,
        0x3737D3A1U, 0xFAFA401DU, 0xC2C2683DU, 0xB4B4CCF0U, 0x32325DDEU,
        0x9C9C71B3U, 0x5656E70BU, 0xE3E3DA72U, 0x878760A7U, 0x15151B1CU,
        0xF9F93AEFU, 0x6363BFD1U, 0x3434A953U, 0x9A9A853EU, 0xB1B1428FU,
        0x7C7CD133U, 0x88889B26U, 0x3D3DA65FU, 0xA1A1D7ECU, 0xE4E4DF76U,
        0x8181942AU, 0x91910149U, 0x0F0FFB81U, 0xEEEEAA88U, 0x161661EEU,
        0xD7D77321U, 0x9797F5C4U, 0xA5A5A81AU, 0xFEFE3FEBU, 0x6D6DB5D9U,
        0x7878AEC5U, 0xC5C56D39U, 0x1D1DE599U, 0x7676A4CDU, 0x3E3EDCADU,
        0xCBCB6731U, 0xB6B6478BU, 0xEFEF5B01U, 0x12121E18U, 0x6060C523U,
        0x6A6AB0DDU, 0x4D4DF61FU, 0xCECEE94EU, 0xDEDE7C2DU, 0x55559DF9U,
        0x7E7E5A48U, 0x2121B24FU, 0x03037AF2U, 0xA0A02665U, 0x5E5E198EU,
        0x5A5A6678U, 0x65654B5CU, 0x62624E58U, 0xFDFD4519U, 0x0606F48DU,
        0x404086E5U, 0xF2F2BE98U, 0x3333AC57U, 0x17179067U, 0x05058E7FU,
        0xE8E85E05U, 0x4F4F7D64U, 0x89896AAFU, 0x10109563U, 0x74742FB6U,
        0x0A0A75FEU, 0x5C5C92F5U, 0x9B9B74B7U, 0x2D2D333CU, 0x3030D6A5U,
        0x2E2E49CEU, 0x494989E9U, 0x46467268U, 0x77775544U, 0xA8A8D8E0U,
        0x9696044DU, 0x2828BD43U, 0xA9A92969U, 0xD9D97929U, 0x8686912EU,
        0xD1D187ACU, 0xF4F44A15U, 0x8D8D1559U, 0xD6D682A8U, 0xB9B9BC0AU,
        0x42420D9EU, 0xF6F6C16EU, 0x2F2FB847U, 0xDDDD06DFU, 0x23233934U,
        0xCCCC6235U, 0xF1F1C46AU, 0xC1C112CFU, 0x8585EBDCU, 0x8F8F9E22U,
        0x7171A1C9U, 0x9090F0C0U, 0xAAAA539BU, 0x0101F189U, 0x8B8BE1D4U,
        0x4E4E8CEDU, 0x8E8E6FABU, 0xABABA212U, 0x6F6F3EA2U, 0xE6E6540DU,
        0xDBDBF252U, 0x92927BBBU, 0xB7B7B602U, 0x6969CA2FU, 0x3939D9A9U,
        0xD3D30CD7U, 0xA7A72361U, 0xA2A2AD1EU, 0xC3C399B4U, 0x6C6C4450U,
        0x07070504U, 0x04047FF6U, 0x272746C2U, 0xACACA716U, 0xD0D07625U,
        0x50501386U, 0xDCDCF756U, 0x84841A55U, 0xE1E15109U, 0x7A7A25BEU,
        0x1313EF91U
      },
      { 0xA9D93939U, 0x67901717U, 0xB3719C9CU, 0xE8D2A6A6U, 0x04050707U,
        0xFD985252U, 0xA3658080U, 0x76DFE4E4U, 0x9A084545U, 0x92024B4BU,
        0x80A0E0E0U, 0x78665A5AU, 0xE4DDAFAFU, 0xDDB06A6AU, 0xD1BF6363U,
        0x38362A2AU, 0x0D54E6E6U, 0xC6432020U, 0x3562CCCCU, 0x98BEF2F2U,
        0x181E1212U, 0xF724EBEBU, 0xECD7A1A1U, 0x6C774141U, 0x43BD2828U,
        0x7532BCBCU, 0x37D47B7BU, 0x269B8888U, 0xFA700D0DU, 0x13F94444U,
        0x94B1FBFBU, 0x485A7E7EU, 0xF27A0303U, 0xD0E48C8CU, 0x8B47B6B6U,
        0x303C2424U, 0x84A5E7E7U, 0x54416B6BU, 0xDF06DDDDU, 0x23C56060U,
        0x1945FDFDU, 0x5BA33A3AU, 0x3D68C2C2U, 0x59158D8DU, 0xF321ECECU,
        0xAE316666U, 0xA23E6F6FU, 0x82165757U, 0x63951010U, 0x015BEFEFU,
        0x834DB8B8U, 0x2E918686U, 0xD9B56D6DU, 0x511F8383U, 0x9B53AAAAU,
        0x7C635D5DU, 0xA63B6868U, 0xEB3FFEFEU, 0xA5D63030U, 0xBE257A7AU,
        0x16A7ACACU, 0x0C0F0909U, 0xE335F0F0U, 0x6123A7A7U, 0xC0F09090U,
        0x8CAFE9E9U, 0x3A809D9DU, 0xF5925C5CU, 0x73810C0CU, 0x2C273131U,
        0x2576D0D0U, 0x0BE75656U, 0xBB7B9292U, 0x4EE9CECEU, 0x89F10101U,
        0x6B9F1E1EU, 0x53A93434U, 0x6AC4F1F1U, 0xB499C3C3U, 0xF1975B5BU,
        0xE1834747U, 0xE66B1818U, 0xBDC82222U, 0x450E9898U, 0xE26E1F1FU,
        0xF4C9B3B3U, 0xB62F7474U, 0x66CBF8F8U, 0xCCFF9999U, 0x95EA1414U,
        0x03ED5858U, 0x56F7DCDCU, 0xD4E18B8BU, 0x1C1B1515U, 0x1EADA2A2U,
        0xD70CD3D3U, 0xFB2BE2E2U, 0xC31DC8C8U, 0x8E195E5EU, 0xB5C22C2CU,
        0xE9894949U, 0xCF12C1C1U, 0xBF7E9595U, 0xBA207D7DU, 0xEA641111U,
        0x77840B0BU, 0x396DC5C5U, 0xAF6A8989U, 0x33D17C7CU, 0xC9A17171U,
        0x62CEFFFFU, 0x7137BBBBU, 0x81FB0F0FU, 0x793DB5B5U, 0x0951E1E1U,
        0xADDC3E3EU, 0x242D3F3FU, 0xCDA47676U, 0xF99D5555U, 0xD8EE8282U,
        0xE5864040U, 0xC5AE7878U, 0xB9CD2525U, 0x4D049696U, 0x44557777U,
        0x080A0E0EU, 0x86135050U, 0xE730F7F7U, 0xA1D33737U, 0x1D40FAFAU,
        0xAA346161U, 0xED8C4E4EU, 0x06B3B0B0U, 0x706C5454U, 0xB22A7373U,
        0xD2523B3BU, 0x410B9F9FU, 0x7B8B0202U, 0xA088D8D8U, 0x114FF3F3U,
        0x3167CBCBU, 0xC2462727U, 0x27C06767U, 0x90B4FCFCU, 0x20283838U,
        0xF67F0404U, 0x60784848U, 0xFF2EE5E5U, 0x96074C4CU, 0x5C4B6565U,
        0xB1C72B2BU, 0xAB6F8E8EU, 0x9E0D4242U, 0x9CBBF5F5U, 0x52F2DBDBU,
        0x1BF34A4AU, 0x5FA63D3DU, 0x9359A4A4U, 0x0ABCB9B9U, 0xEF3AF9F9U,
        0x91EF1313U, 0x85FE0808U, 0x49019191U, 0xEE611616U, 0x2D7CDEDEU,
        0x4FB22121U, 0x8F42B1B1U, 0x3BDB7272U, 0x47B82F2FU, 0x8748BFBFU,
        0x6D2CAEAEU, 0x46E3C0C0U, 0xD6573C3CU, 0x3E859A9AU, 0x6929A9A9U,
        0x647D4F4FU, 0x2A948181U, 0xCE492E2EU, 0xCB17C6C6U, 0x2FCA6969U,
        0xFCC3BDBDU, 0x975CA3A3U, 0x055EE8E8U, 0x7AD0EDEDU, 0xAC87D1D1U,
        0x7F8E0505U, 0xD5BA6464U, 0x1AA8A5A5U, 0x4BB72626U, 0x0EB9BEBEU,
        0xA7608787U, 0x5AF8D5D5U, 0x28223636U, 0x14111B1BU, 0x3FDE7575U,
        0x2979D9D9U, 0x88AAEEEEU, 0x3C332D2DU, 0x4C5F7979U, 0x02B6B7B7U,
        0xB896CACAU, 0xDA583535U, 0xB09CC4C4U, 0x17FC4343U, 0x551A8484U,
        0x1FF64D4DU, 0x8A1C5959U, 0x7D38B2B2U, 0x57AC3333U, 0xC718CFCFU,
        0x8DF40606U, 0x74695353U, 0xB7749B9BU, 0xC4F59797U, 0x9F56ADADU,
        0x72DAE3E3U, 0x7ED5EAEAU, 0x154AF4F4U, 0x229E8F8FU, 0x12A2ABABU,
        0x584E6262U, 0x07E85F5FU, 0x99E51D1DU, 0x34392323U, 0x6EC1F6F6U,
        0x50446C6CU, 0xDE5D3232U, 0x68724646U, 0x6526A0A0U, 0xBC93CDCDU,
        0xDB03DADAU, 0xF8C6BABAU, 0xC8FA9E9EU, 0xA882D6D6U, 0x2BCF6E6EU,
        0x40507070U, 0xDCEB8585U, 0xFE750A0AU, 0x328A9393U, 0xA48DDFDFU,
        0xCA4C2929U, 0x10141C1CU, 0x2173D7D7U, 0xF0CCB4B4U, 0xD309D4D4U,
        0x5D108A8AU, 0x0FE25151U, 0x00000000U, 0x6F9A1919U, 0x9DE01A1AU,
        0x368F9494U, 0x42E6C7C7U, 0x4AECC9C9U, 0x5EFDD2D2U, 0xC1AB7F7FU,
        0xE0D8A8A8U
      },
      { 0xBC75BC32U, 0xECF3EC21U, 0x20C62043U, 0xB3F4B3C9U, 0xDADBDA03U,
        0x027B028BU, 0xE2FBE22BU, 0x9EC89EFAU, 0xC94AC9ECU, 0xD4D3D409U,
        0x18E6186BU, 0x1E6B1E9FU, 0x9845980EU, 0xB27DB238U, 0xA6E8A6D2U,
        0x264B26B7U, 0x3CD63C57U, 0x9332938AU, 0x82D882EEU, 0x52FD5298U,
        0x7B377BD4U, 0xBB71BB37U, 0x5BF15B97U, 0x47E14783U, 0x2430243CU,
        0x510F51E2U, 0xBAF8BAC6U, 0x4A1B4AF3U, 0xBF87BF48U, 0x0DFA0D70U,
        0xB006B0B3U, 0x753F75DEU, 0xD25ED2FDU, 0x7DBA7D20U, 0x66AE6631U,
        0x3A5B3AA3U, 0x598A591CU, 0x00000000U, 0xCDBCCD93U, 0x1A9D1AE0U,
        0xAE6DAE2CU, 0x7FC17FABU, 0x2BB12BC7U, 0xBE0EBEB9U, 0xE080E0A0U,
        0x8A5D8A10U, 0x3BD23B52U, 0x64D564BAU, 0xD8A0D888U, 0xE784E7A5U,
        0x5F075FE8U, 0x1B141B11U, 0x2CB52CC2U, 0xFC90FCB4U, 0x312C3127U,
        0x80A38065U, 0x73B2732AU, 0x0C730C81U, 0x794C795FU, 0x6B546B41U,
        0x4B924B02U, 0x53745369U, 0x9436948FU, 0x8351831FU, 0x2A382A36U,
        0xC4B0C49CU, 0x22BD22C8U, 0xD55AD5F8U, 0xBDFCBDC3U, 0x48604878U,
        0xFF62FFCEU, 0x4C964C07U, 0x416C4177U, 0xC742C7E6U, 0xEBF7EB24U,
        0x1C101C14U, 0x5D7C5D63U, 0x36283622U, 0x672767C0U, 0xE98CE9AFU,
        0x441344F9U, 0x149514EAU, 0xF59CF5BBU, 0xCFC7CF18U, 0x3F243F2DU,
        0xC046C0E3U, 0x723B72DBU, 0x5470546CU, 0x29CA294CU, 0xF0E3F035U,
        0x088508FEU, 0xC6CBC617U, 0xF311F34FU, 0x8CD08CE4U, 0xA493A459U,
        0xCAB8CA96U, 0x68A6683BU, 0xB883B84DU, 0x38203828U, 0xE5FFE52EU,
        0xAD9FAD56U, 0x0B770B84U, 0xC8C3C81DU, 0x99CC99FFU, 0x580358EDU,
        0x196F199AU, 0x0E080E0AU, 0x95BF957EU, 0x70407050U, 0xF7E7F730U,
        0x6E2B6ECFU, 0x1FE21F6EU, 0xB579B53DU, 0x090C090FU, 0x61AA6134U,
        0x57825716U, 0x9F419F0BU, 0x9D3A9D80U, 0x11EA1164U, 0x25B925CDU,
        0xAFE4AFDDU, 0x459A4508U, 0xDFA4DF8DU, 0xA397A35CU, 0xEA7EEAD5U,
        0x35DA3558U, 0xED7AEDD0U, 0x431743FCU, 0xF866F8CBU, 0xFB94FBB1U,
        0x37A137D3U, 0xFA1DFA40U, 0xC23DC268U, 0xB4F0B4CCU, 0x32DE325DU,
        0x9CB39C71U, 0x560B56E7U, 0xE372E3DAU, 0x87A78760U, 0x151C151BU,
        0xF9EFF93AU, 0x63D163BFU, 0x345334A9U, 0x9A3E9A85U, 0xB18FB142U,
        0x7C337CD1U, 0x8826889BU, 0x3D5F3DA6U, 0xA1ECA1D7U, 0xE476E4DFU,
        0x812A8194U, 0x91499101U, 0x0F810FFBU, 0xEE88EEAAU, 0x16EE1661U,
        0xD721D773U, 0x97C497F5U, 0xA51AA5A8U, 0xFEEBFE3FU, 0x6DD96DB5U,
        0x78C578AEU, 0xC539C56DU, 0x1D991DE5U, 0x76CD76A4U, 0x3EAD3EDCU,
        0xCB31CB67U, 0xB68BB647U, 0xEF01EF5BU, 0x1218121EU, 0x602360C5U,
        0x6ADD6AB0U, 0x4D1F4DF6U, 0xCE4ECEE9U, 0xDE2DDE7CU, 0x55F9559DU,
        0x7E487E5AU, 0x214F21B2U, 0x03F2037AU, 0xA065A026U, 0x5E8E5E19U,
        0x5A785A66U, 0x655C654BU, 0x6258624EU, 0xFD19FD45U, 0x068D06F4U,
        0x40E54086U, 0xF298F2BEU, 0x335733ACU, 0x17671790U, 0x057F058EU,
        0xE805E85EU, 0x4F644F7DU, 0x89AF896AU, 0x10631095U, 0x74B6742FU,
        0x0AFE0A75U, 0x5CF55C92U, 0x9BB79B74U, 0x2D3C2D33U, 0x30A530D6U,
        0x2ECE2E49U, 0x49E94989U, 0x46684672U, 0x77447755U, 0xA8E0A8D8U,
        0x964D9604U, 0x284328BDU, 0xA969A929U, 0xD929D979U, 0x862E8691U,
        0xD1ACD187U, 0xF415F44AU, 0x8D598D15U, 0xD6A8D682U, 0xB90AB9BCU,
        0x429E420DU, 0xF66EF6C1U, 0x2F472FB8U, 0xDDDFDD06U, 0x23342339U,
        0xCC35CC62U, 0xF16AF1C4U, 0xC1CFC112U, 0x85DC85EBU, 0x8F228F9EU,
        0x71C971A1U, 0x90C090F0U, 0xAA9BAA53U, 0x018901F1U, 0x8BD48BE1U,
        0x4EED4E8CU, 0x8EAB8E6FU, 0xAB12ABA2U, 0x6FA26F3EU, 0xE60DE654U,
        0xDB52DBF2U, 0x92BB927BU, 0xB702B7B6U, 0x692F69CAU, 0x39A939D9U,
        0xD3D7D30CU, 0xA761A723U, 0xA21EA2ADU, 0xC3B4C399U, 0x6C506C44U,
        0x07040705U, 0x04F6047FU, 0x27C22746U, 0xAC16ACA7U, 0xD025D076U,
        0x50865013U, 0xDC56DCF7U, 0x8455841AU, 0xE109E151U, 0x7ABE7A25U,
        0x139113EFU
      },
      { 0xD939A9D9U, 0x90176790U, 0x719CB371U, 0xD2A6E8D2U, 0x05070405U,
        0x9852FD98U, 0x6580A365U, 0xDFE476DFU, 0x08459A08U, 0x024B9202U,
        0xA0E080A0U, 0x665A7866U, 0xDDAFE4DDU, 0xB06ADDB0U, 0xBF63D1BFU,
        0x362A3836U, 0x54E60D54U, 0x4320C643U, 0x62CC3562U, 0xBEF298BEU,
        0x1E12181EU, 0x24EBF724U, 0xD7A1ECD7U, 0x77416C77U, 0xBD2843BDU,
        0x32BC7532U, 0xD47B37D4U, 0x9B88269BU, 0x700DFA70U, 0xF94413F9U,
        0xB1FB94B1U, 0x5A7E485AU, 0x7A03F27AU, 0xE48CD0E4U, 0x47B68B47U,
        0x3C24303CU, 0xA5E784A5U, 0x416B5441U, 0x06DDDF06U, 0xC56023C5U,
        0x45FD1945U, 0xA33A5BA3U, 0x68C23D68U, 0x158D5915U, 0x21ECF321U,
        0x3166AE31U, 0x3E6FA23EU, 0x16578216U, 0x95106395U, 0x5BEF015BU,
        0x4DB8834DU, 0x91862E91U, 0xB56DD9B5U, 0x1F83511FU, 0x53AA9B53U,
        0x635D7C63U, 0x3B68A63BU, 0x3FFEEB3FU, 0xD630A5D6U, 0x257ABE25U,
        0xA7AC16A7U, 0x0F090C0FU, 0x35F0E335U, 0x23A76123U, 0xF090C0F0U,
        0xAFE98CAFU, 0x809D3A80U, 0x925CF592U, 0x810C7381U, 0x27312C27U,
        0x76D02576U, 0xE7560BE7U, 0x7B92BB7BU, 0xE9CE4EE9U, 0xF10189F1U,
        0x9F1E6B9FU, 0xA93453A9U, 0xC4F16AC4U, 0x99C3B499U, 0x975BF197U,
        0x8347E183U, 0x6B18E66BU, 0xC822BDC8U, 0x0E98450EU, 0x6E1FE26EU,
        0xC9B3F4C9U, 0x2F74B62FU, 0xCBF866CBU, 0xFF99CCFFU, 0xEA1495EAU,
        0xED5803EDU, 0xF7DC56F7U, 0xE18BD4E1U, 0x1B151C1BU, 0xADA21EADU,
        0x0CD3D70CU, 0x2BE2FB2BU, 0x1DC8C31DU, 0x195E8E19U, 0xC22CB5C2U,
        0x8949E989U, 0x12C1CF12U, 0x7E95BF7EU, 0x207DBA20U, 0x6411EA64U,
        0x840B7784U, 0x6DC5396DU, 0x6A89AF6AU, 0xD17C33D1U, 0xA171C9A1U,
        0xCEFF62CEU, 0x37BB7137U, 0xFB0F81FBU, 0x3DB5793DU, 0x51E10951U,
        0xDC3EADDCU, 0x2D3F242DU, 0xA476CDA4U, 0x9D55F99DU, 0xEE82D8EEU,
        0x8640E586U, 0xAE78C5AEU, 0xCD25B9CDU, 0x04964D04U, 0x55774455U,
        0x0A0E080AU, 0x13508613U, 0x30F7E730U, 0xD337A1D3U, 0x40FA1D40U,
        0x3461AA34U, 0x8C4EED8CU, 0xB3B006B3U, 0x6C54706CU, 0x2A73B22AU,
        0x523BD252U, 0x0B9F410BU, 0x8B027B8BU, 0x88D8A088U, 0x4FF3114FU,
        0x67CB3167U, 0x4627C246U, 0xC06727C0U, 0xB4FC90B4U, 0x28382028U,
        0x7F04F67FU, 0x78486078U, 0x2EE5FF2EU, 0x074C9607U, 0x4B655C4BU,
        0xC72BB1C7U, 0x6F8EAB6FU, 0x0D429E0DU, 0xBBF59CBBU, 0xF2DB52F2U,
        0xF34A1BF3U, 0xA63D5FA6U, 0x59A49359U, 0xBCB90ABCU, 0x3AF9EF3AU,
        0xEF1391EFU, 0xFE0885FEU, 0x01914901U, 0x6116EE61U, 0x7CDE2D7CU,
        0xB2214FB2U, 0x42B18F42U, 0xDB723BDBU, 0xB82F47B8U, 0x48BF8748U,
        0x2CAE6D2CU, 0xE3C046E3U, 0x573CD657U, 0x859A3E85U, 0x29A96929U,
        0x7D4F647DU, 0x94812A94U, 0x492ECE49U, 0x17C6CB17U, 0xCA692FCAU,
        0xC3BDFCC3U, 0x5CA3975CU, 0x5EE8055EU, 0xD0ED7AD0U, 0x87D1AC87U,
        0x8E057F8EU, 0xBA64D5BAU, 0xA8A51AA8U, 0xB7264BB7U, 0xB9BE0EB9U,
        0x6087A760U, 0xF8D55AF8U, 0x22362822U, 0x111B1411U, 0xDE753FDEU,
        0x79D92979U, 0xAAEE88AAU, 0x332D3C33U, 0x5F794C5FU, 0xB6B702B6U,
        0x96CAB896U, 0x5835DA58U, 0x9CC4B09CU, 0xFC4317FCU, 0x1A84551AU,
        0xF64D1FF6U, 0x1C598A1CU, 0x38B27D38U, 0xAC3357ACU, 0x18CFC718U,
        0xF4068DF4U, 0x69537469U, 0x749BB774U, 0xF597C4F5U, 0x56AD9F56U,
        0xDAE372DAU, 0xD5EA7ED5U, 0x4AF4154AU, 0x9E8F229EU, 0xA2AB12A2U,
        0x4E62584EU, 0xE85F07E8U, 0xE51D99E5U, 0x39233439U, 0xC1F66EC1U,
        0x446C5044U, 0x5D32DE5DU, 0x72466872U, 0x26A06526U, 0x93CDBC93U,
        0x03DADB03U, 0xC6BAF8C6U, 0xFA9EC8FAU, 0x82D6A882U, 0xCF6E2BCFU,
        0x50704050U, 0xEB85DCEBU, 0x750AFE75U, 0x8A93328AU, 0x8DDFA48DU,
        0x4C29CA4CU, 0x141C1014U, 0x73D72173U, 0xCCB4F0CCU, 0x09D4D309U,
        0x108A5D10U, 0xE2510FE2U, 0x00000000U, 0x9A196F9AU, 0xE01A9DE0U,
        0x8F94368FU, 0xE6C742E6U, 0xECC94AECU, 0xFDD25EFDU, 0xAB7FC1ABU,
        0xD8A8E0D8U
      }
    };

  ssize_t
    j,
    k;

  register ssize_t
    i;

  register unsigned char
    *p;

  unsigned char
    crypt_key[32],
    s0,
    s1,
    s2,
    s3,
    s4,
    s5,
    s6,
    s7,
    s8,
    s9,
    s10,
    s11,
    s12,
    s13,
    s14,
    s15,
    xi;

  unsigned char
    *datum;

  unsigned int
    rho,
    sigma;

  /*
    Generate crypt key.
  */
  (void) LogWizardEvent(TraceEvent,GetWizardModule(),"...");
  WizardAssert(CipherDomain,twofish_info != (TwofishInfo *) NULL);
  WizardAssert(CipherDomain,twofish_info->signature == WizardSignature);
  WizardAssert(CipherDomain,key != (StringInfo *) NULL);
  (void) memset(crypt_key,0,sizeof(crypt_key));
  p=(unsigned char *) crypt_key;
  datum=GetStringInfoDatum(key);
  for (i=0; i < (ssize_t) Min(GetStringInfoLength(key),MaximumTwofishKeyLength); i++)
    p[i]=datum[i];
  if (i < MaximumTwofishKeyLength)
    p[i++]=1;
  while (i < MaximumTwofishKeyLength)
    p[i++]=0;
  s0=0;
  s1=0;
  s2=0;
  s3=0;
  s4=0;
  s5=0;
  s6=0;
  s7=0;
  s8=0;
  s9=0;
  s10=0;
  s11=0;
  s12=0;
  s13=0;
  s14=0;
  s15=0;
  Sbox(s0,s1,s2,s3,0,0x00,0x2D,0x01,0x2D);
  Sbox(s0,s1,s2,s3,1,0x2D,0xA4,0x44,0x8A);
  Sbox(s0,s1,s2,s3,2,0x8A,0xD5,0xBF,0xD1);
  Sbox(s0,s1,s2,s3,3,0xD1,0x7F,0x3D,0x99);
  Sbox(s0,s1,s2,s3,4,0x99,0x46,0x66,0x96);
  Sbox(s0,s1,s2,s3,5,0x96,0x3C,0x5B,0xED);
  Sbox(s0,s1,s2,s3,6,0xED,0x37,0x4F,0xE0);
  Sbox(s0,s1,s2,s3,7,0xE0,0xD0,0x8C,0x17);
  Sbox(s4,s5,s6,s7,8,0x00,0x2D,0x01,0x2D);
  Sbox(s4,s5,s6,s7,9,0x2D,0xA4,0x44,0x8A);
  Sbox(s4,s5,s6,s7,10,0x8A,0xD5,0xBF,0xD1);
  Sbox(s4,s5,s6,s7,11,0xD1,0x7F,0x3D,0x99);
  Sbox(s4,s5,s6,s7,12,0x99,0x46,0x66,0x96);
  Sbox(s4,s5,s6,s7,13,0x96,0x3C,0x5B,0xED);
  Sbox(s4,s5,s6,s7,14,0xED,0x37,0x4F,0xE0);
  Sbox(s4,s5,s6,s7,15,0xE0,0xD0,0x8C,0x17);
  if ((8*GetStringInfoLength(key)) >= 192)
    {
      /*
        192- or 256-bit key.
      */
      Sbox(s8,s9,s10,s11,16,0x00,0x2D,0x01,0x2D);
      Sbox(s8,s9,s10,s11,17,0x2D,0xA4,0x44,0x8A);
      Sbox(s8,s9,s10,s11,18,0x8A,0xD5,0xBF,0xD1);
      Sbox(s8,s9,s10,s11,19,0xD1,0x7F,0x3D,0x99);
      Sbox(s8,s9,s10,s11,20,0x99,0x46,0x66,0x96);
      Sbox(s8,s9,s10,s11,21,0x96,0x3C,0x5B,0xED);
      Sbox(s8,s9,s10,s11,22,0xED,0x37,0x4F,0xE0);
      Sbox(s8,s9,s10,s11,23,0xE0,0xD0,0x8C,0x17);
    }
  j=0;
  k=1;
  if ((8*GetStringInfoLength(key)) >= 256)
    {
      /*
        256-bit key.
      */
      Sbox(s12,s13,s14,s15,24,0x00,0x2D,0x01,0x2D);
      Sbox(s12,s13,s14,s15,25,0x2D,0xA4,0x44,0x8A);
      Sbox(s12,s13,s14,s15,26,0x8A,0xD5,0xBF,0xD1);
      Sbox(s12,s13,s14,s15,27,0xD1,0x7F,0x3D,0x99);
      Sbox(s12,s13,s14,s15,28,0x99,0x46,0x66,0x96);
      Sbox(s12,s13,s14,s15,29,0x96,0x3C,0x5B,0xED);
      Sbox(s12,s13,s14,s15,30,0xED,0x37,0x4F,0xE0);
      Sbox(s12,s13,s14,s15,31,0xE0,0xD0,0x8C,0x17);
      for (i=0; i < 256; i++)
      {
        twofish_info->sbox[0][i]=
          mds[0][q0[q0[q1[sbox[k] ^ s0] ^ s4] ^ s8] ^ s12];
        twofish_info->sbox[1][i]=
          mds[1][q0[q1[q1[sbox[j] ^ s1] ^ s5] ^ s9] ^ s13];
        twofish_info->sbox[2][i]=
          mds[2][q1[q0[q0[sbox[j] ^ s2] ^ s6] ^ s10] ^ s14];
        twofish_info->sbox[3][i]=
          mds[3][q1[q1[q0[sbox[k] ^ s3] ^ s7] ^ s11] ^ s15];
        j+=2;
        k+=2;
      }
      K256(w,0,0xA9,0x75,0x67,0xF3);
      K256(w,2,0xB3,0xC6,0xE8,0xF4);
      K256(w,4,0x04,0xDB,0xFD,0x7B);
      K256(w,6,0xA3,0xFB,0x76,0xC8);
      K256(k,0,0x9A,0x4A,0x92,0xD3);
      K256(k,2,0x80,0xE6,0x78,0x6B);
      K256(k,4,0xE4,0x45,0xDD,0x7D);
      K256(k,6,0xD1,0xE8,0x38,0x4B);
      K256(k,8,0x0D,0xD6,0xC6,0x32);
      K256(k,10,0x35,0xD8,0x98,0xFD);
      K256(k,12,0x18,0x37,0xF7,0x71);
      K256(k,14,0xEC,0xF1,0x6C,0xE1);
      K256(k,16,0x43,0x30,0x75,0x0F);
      K256(k,18,0x37,0xF8,0x26,0x1B);
      K256(k,20,0xFA,0x87,0x13,0xFA);
      K256(k,22,0x94,0x06,0x48,0x3F);
      K256(k,24,0xF2,0x5E,0xD0,0xBA);
      K256(k,26,0x8B,0xAE,0x30,0x5B);
      K256(k,28,0x84,0x8A,0x54,0x00);
      K256(k,30,0xDF,0xBC,0x23,0x9D);
    }
  else
    if ((8*GetStringInfoLength(key)) >= 192)
      {
        /*
          192-bit key.
        */
        for (i=0; i < 256; i++)
        {
          twofish_info->sbox[0][i]=mds[0][q0[q0[sbox[k] ^ s0] ^ s4] ^ s8];
          twofish_info->sbox[1][i]=mds[1][q0[q1[sbox[k] ^ s1] ^ s5] ^ s9];
          twofish_info->sbox[2][i]=mds[2][q1[q0[sbox[j] ^ s2] ^ s6] ^ s10];
          twofish_info->sbox[3][i]=mds[3][q1[q1[sbox[j] ^ s3] ^ s7] ^ s11];
          j+=2;
          k+=2;
        }
        K192(w,0,0xA9,0x75,0x67,0xF3);
        K192(w,2,0xB3,0xC6,0xE8,0xF4);
        K192(w,4,0x04,0xDB,0xFD,0x7B);
        K192(w,6,0xA3,0xFB,0x76,0xC8);
        K192(k,0,0x9A,0x4A,0x92,0xD3);
        K192(k,2,0x80,0xE6,0x78,0x6B);
        K192(k,4,0xE4,0x45,0xDD,0x7D);
        K192(k,6,0xD1,0xE8,0x38,0x4B);
        K192(k,8,0x0D,0xD6,0xC6,0x32);
        K192(k,10,0x35,0xD8,0x98,0xFD);
        K192(k,12,0x18,0x37,0xF7,0x71);
        K192(k,14,0xEC,0xF1,0x6C,0xE1);
        K192(k,16,0x43,0x30,0x75,0x0F);
        K192(k,18,0x37,0xF8,0x26,0x1B);
        K192(k,20,0xFA,0x87,0x13,0xFA);
        K192(k,22,0x94,0x06,0x48,0x3F);
        K192(k,24,0xF2,0x5E,0xD0,0xBA);
        K192(k,26,0x8B,0xAE,0x30,0x5B);
        K192(k,28,0x84,0x8A,0x54,0x00);
        K192(k,30,0xDF,0xBC,0x23,0x9D);
      }
    else
      {
        /*
          128-bit key.
        */
        for (i=0; i < 256; i++)
        {
          twofish_info->sbox[0][i]=mds[0][q0[sbox[j] ^ s0] ^ s4];
          twofish_info->sbox[1][i]=mds[1][q0[sbox[k] ^ s1] ^ s5];
          twofish_info->sbox[2][i]=mds[2][q1[sbox[j] ^ s2] ^ s6];
          twofish_info->sbox[3][i]=mds[3][q1[sbox[k] ^ s3] ^ s7];
          j+=2;
          k+=2;
        }
        K128(w,0,0xA9,0x75,0x67,0xF3);
        K128(w,2,0xB3,0xC6,0xE8,0xF4);
        K128(w,4,0x04,0xDB,0xFD,0x7B);
        K128(w,6,0xA3,0xFB,0x76,0xC8);
        K128(k,0,0x9A,0x4A,0x92,0xD3);
        K128(k,2,0x80,0xE6,0x78,0x6B);
        K128(k,4,0xE4,0x45,0xDD,0x7D);
        K128(k,6,0xD1,0xE8,0x38,0x4B);
        K128(k,8,0x0D,0xD6,0xC6,0x32);
        K128(k,10,0x35,0xD8,0x98,0xFD);
        K128(k,12,0x18,0x37,0xF7,0x71);
        K128(k,14,0xEC,0xF1,0x6C,0xE1);
        K128(k,16,0x43,0x30,0x75,0x0F);
        K128(k,18,0x37,0xF8,0x26,0x1B);
        K128(k,20,0xFA,0x87,0x13,0xFA);
        K128(k,22,0x94,0x06,0x48,0x3F);
        K128(k,24,0xF2,0x5E,0xD0,0xBA);
        K128(k,26,0x8B,0xAE,0x30,0x5B);
        K128(k,28,0x84,0x8A,0x54,0x00);
        K128(k,30,0xDF,0xBC,0x23,0x9D);
      }
  /*
    Reset registers.
  */
  (void) ResetWizardMemory(crypt_key,0,sizeof(crypt_key));
  rho=0;
  sigma=0;
  s0=0;
  s1=0;
  s2=0;
  s3=0;
  s4=0;
  s5=0;
  s6=0;
  s7=0;
  s8=0;
  s9=0;
  s10=0;
  s11=0;
  s12=0;
  s13=0;
  s14=0;
  s15=0;
  xi=0;
}
